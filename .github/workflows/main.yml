name: Android AVD + Tailscale (scrcpy)

on:
  workflow_dispatch:

jobs:
  avd:
    runs-on: ubuntu-22.04

    steps:
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup /mnt Storage
        run: |
          sudo mkdir -p /mnt/avd
          sudo chown -R runner:runner /mnt/avd

      - name: Install System Image
        run: |
          sdkmanager "system-images;android-30;google_apis;x86_64"

      - name: Create AVD on /mnt
        run: |
          export HOME=/mnt/avd
          export ANDROID_AVD_HOME=/mnt/avd/.android/avd
          
          echo no | avdmanager create avd \
            -n android11 \
            -k "system-images;android-30;google_apis;x86_64" \
            -d "pixel_5"
          
          cat >> /mnt/avd/.android/avd/android11.avd/config.ini << EOF
          hw.ramSize=8192
          disk.dataPartition.size=8192M
          hw.gpu.mode=swiftshader_indirect
          hw.gpu.enabled=yes
          EOF

      - name: Start AVD
        run: |
          export HOME=/mnt/avd
          export ANDROID_AVD_HOME=/mnt/avd/.android/avd
          
          nohup $ANDROID_HOME/emulator/emulator \
            -avd android11 \
            -no-window \
            -gpu swiftshader_indirect \
            -no-audio \
            -no-boot-anim \
            -memory 8192 \
            > /tmp/emu.log 2>&1 &
          
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          echo "âœ… AVD booted with 8GB RAM"

      - name: Enable Native Lock
        run: |
          adb shell cmd lock_settings set-pin 1234
          echo "âœ… Lock screen enabled"

      - name: Enable ADB TCP
        run: |
          adb tcpip 5555
          sleep 2

      - name: Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“± AVD Ready (8GB RAM)        â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  IP: $TS_IP:5555              â•‘"
          echo "â•‘  RAM: 8GB                     â•‘"
          echo "â•‘  Lock PIN: 1234               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Connect from your PC:"
          echo "  adb connect $TS_IP:5555"
          echo "  scrcpy --serial $TS_IP:5555"

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date '+%H:%M')] âœ… $TAILSCALE_IP:5555 | 8GB RAM"
            sleep 120
          done
