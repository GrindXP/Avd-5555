name: Android Emulator with FRP

on: [push, workflow_dispatch]

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_11
      AVD_API_LEVEL: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 30
          ndk-version: r21e
          components: emulator,platform-tools

      - name: Install System Image
        run: |
          sdkmanager "system-images;android-30;google_apis;x86_64"

      - name: Create AVD
        run: |
          echo no | avdmanager create avd --force --name ${{ env.AVD_NAME }} --package "system-images;android-30;google_apis;x86_64" --device "pixel" --sdcard 8192M
          AVD_DIR="$HOME/.android/avd/${{ env.AVD_NAME }}.avd"
          mkdir -p $AVD_DIR
          echo "hw.ramSize=16384" >> $AVD_DIR/config.ini
          echo "disk.dataPartition.size=65536m" >> $AVD_DIR/config.ini
          echo "hw.gpu.mode=swiftshader_indirect" >> $AVD_DIR/config.ini

      - name: Start Emulator
        run: |
          nohup emulator -avd ${{ env.AVD_NAME }} -no-window -no-audio -no-snapshot -partition-size 65536 > emulator.log 2>&1 &
          sleep 60
          adb wait-for-device
          adb devices

      - name: Enable ADB TCP
        run: |
          adb tcpip 5555
          sleep 5

      - name: Setup frpc
        run: |
          cat > frpc.ini <<'EOF'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000

          [adb]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5555
          remote_port = 5555
          EOF

          wget https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          nohup ./frp_0.58.1_linux_amd64/frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 10

      - name: Verify ADB Connection
        run: |
          adb devices
          netstat -tuln | grep 5555

      - name: Keep job running for testing
        run: sleep 600
