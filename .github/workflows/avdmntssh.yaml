name: Android PlayStore Emulator with VNC on 5900

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'Runtime duration (minutes)'
        required: false
        default: '360'

permissions:
  contents: write

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_11
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '360' }}
      VPS_IP: 159.195.6.61
      FRP_SERVER_PORT: 7000
      FRP_VERSION: 0.65.0

    steps:

    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        sudo chmod 666 /dev/kvm || true
        echo "✅ KVM enabled"

    - name: Install display packages
      run: |
        sudo apt update -y
        sudo apt install -y xvfb x11vnc
        echo "✅ Xvfb & VNC installed"

    - name: Install Android Emulator & Image
      run: |
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        sdkmanager "emulator" "platform-tools"
        sdkmanager "system-images;android-30;google_apis_playstore;x86_64"

    - name: Create AVD
      run: |
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        mkdir -p ~/.android/avd

        echo no | avdmanager create avd \
          --force \
          --name android_11 \
          --package "system-images;android-30;google_apis_playstore;x86_64" \
          --device "pixel"

        AVD_DIR=~/.android/avd/android_11.avd

        cat >> "$AVD_DIR/config.ini" <<EOF
hw.ramSize=6144
disk.dataPartition.size=20G
hw.cpu.ncore=4
PlayStore.enabled=true
hw.gpu.enabled=yes
hw.gpu.mode=auto
hw.feature.jemalloc=false
EOF
        echo "✅ AVD configured"

    - name: Start Xvfb
      run: |
        Xvfb :99 -screen 0 1920x1080x24 &
        echo "✅ Xvfb running"

    - name: Start VNC
      run: |
        DISPLAY=:99 x11vnc -forever -nopw -bg -rfbport 5900
        echo "✅ VNC started on 5900"

    - name: Start Emulator
      run: |
        export DISPLAY=:99
        export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
        
        nohup emulator -avd android_11 \
          -no-snapshot-load \
          -accel auto \
          -gpu swiftshader_indirect \
          -noaudio \
          -nocamera \
          -no-boot-anim \
          -no-snapshot-save \
          -no-window > /tmp/emulator.log 2>&1 &

        echo "⏳ Booting emulator..."
        sleep 90

        adb start-server
        adb wait-for-device
        echo "✅ Emulator started"

    - name: Connect FRP
      run: |
        mkdir -p /tmp/frp && cd /tmp/frp
        wget -q https://github.com/fatedier/frp/releases/download/v${{ env.FRP_VERSION }}/frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz
        tar -zxf frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz
        cd frp_${{ env.FRP_VERSION }}_linux_amd64

        cat > frpc.toml <<EOF
serverAddr = "${{ env.VPS_IP }}"
serverPort = 7000

[[proxies]]
name = "android-vnc"
type = "tcp"
localIP = "127.0.0.1"
localPort = 5900
remotePort = 5900
EOF

        nohup ./frpc -c frpc.toml &
        echo "✅ FRP tunnel active (VNC forwarded)"

    - name: tmate SSH
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: false
        connect-timeout-seconds: 120

    - name: Keep alive
      run: |
        echo "⏳ Keeping Emulator alive for $RUNTIME_MINUTES minutes..."
        sleep $((60 * RUNTIME_MINUTES))
        echo "✅ Finished"
