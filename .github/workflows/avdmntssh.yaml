name: Android PlayStore Emulator + VNC Tunnel + SSH

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'Runtime duration (minutes)'
        required: false
        default: '120'

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_11
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '120' }}
      FRP_VERSION: 0.65.0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Display + Networking Packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y x11vnc xvfb wget

      - name: Install PlayStore System Image
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          sdkmanager "emulator" "platform-tools"
          sdkmanager "system-images;android-30;google_apis_playstore;x86_64"

      - name: Create PlayStore AVD on /mnt
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          sudo mkdir -p /mnt/android-home/.android/avd
          sudo chown -R runner:runner /mnt/android-home
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          echo no | avdmanager create avd \
            --force --name "${AVD_NAME}" \
            --package "system-images;android-30;google_apis_playstore;x86_64" \
            --device "pixel"
          AVD_DIR="/mnt/android-home/.android/avd/${AVD_NAME}.avd"
          cat >> "$AVD_DIR/config.ini" << EOF
          hw.ramSize=4096
          disk.dataPartition.size=8192m
          PlayStore.enabled=yes
          EOF

      - name: Start Xvfb Display
        run: |
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          sleep 3

      - name: Start VNC Server
        run: |
          export DISPLAY=:99
          x11vnc -display :99 -forever -nopw -rfbport 5900 -bg
          sleep 3

      - name: Download & Start FRP Tunnel to VPS
        run: |
          mkdir -p /tmp/frp
          cd /tmp/frp
          wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
          tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz
          cat > frpc.toml <<FRPCONF
          serverAddr = "159.195.6.61"
          serverPort = 7000
          [[proxies]]
          name = "vnc-emulator-5900"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5900
          remotePort = 5900
          FRPCONF
          cd frp_${FRP_VERSION}_linux_amd64
          nohup ./frpc -c ../frpc.toml > /tmp/frpc.log 2>&1 &

      - name: Start Emulator
        run: |
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          export DISPLAY=:99
          nohup emulator -avd "${AVD_NAME}" -netdelay none -noaudio -no-boot-anim -no-window > /tmp/emulator.log 2>&1 &
          echo "Booting emulator..."
          for i in {1..120}; do
            if adb devices | grep -q "emulator"; then
              echo "Emulator booted!"
              break
            fi
            sleep 5
          done

      - name: Show VNC Connection Info
        run: |
          echo "======================================"
          echo "Connect your VNC Viewer to:"
          echo "159.195.6.61:5900"
          echo "Username: (none)"
          echo "Password: (none)"
          echo "You can SSH/tmate into the runner to start/restart/stop the emulator as needed."
          echo "======================================"

      - name: SSH via tmate
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
          connect-timeout-seconds: 120

      - name: Keep Running (for session)
        run: |
          sleep $(( ${{ env.RUNTIME_MINUTES }} * 60 ))
