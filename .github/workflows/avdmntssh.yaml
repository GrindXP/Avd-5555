name: Android PlayStore Emulator with VNC

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'Total runtime for the session in minutes'
        required: true
        default: '360'
      vps_ip:
        description: 'IP address of your FRP server'
        required: true
      frp_port:
        description: 'Port of your FRP server (frps bind_port)'
        required: true
        default: '7000'

jobs:
  android-emulator-session:
    runs-on: ubuntu-latest

    env:
      # --- AVD & System Configuration ---
      AVD_NAME: android_30_playstore
      SYSTEM_IMAGE: "system-images;android-30;google_apis_playstore;x86_64"
      DEVICE_PROFILE: "pixel_6"
      
      # --- FRP Tunnel Configuration ---
      FRP_VERSION: 0.65.0
      VPS_IP: ${{ github.event.inputs.vps_ip }}
      FRP_SERVER_PORT: ${{ github.event.inputs.frp_port }}
      
      # --- Session & Display Configuration ---
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes }}
      DISPLAY_PORT: ':99'
      VNC_PORT: 5900

    steps:
      # ---------------------------------
      # STEP 1: CHECKOUT & ENVIRONMENT SETUP
      # ---------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ---------------------------------
      # STEP 2: ENABLE KVM ACCELERATION
      # ---------------------------------
      - name: Enable KVM Hardware Acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm
          echo "✅ KVM acceleration enabled."

      # ---------------------------------
      # STEP 3: PREPARE STORAGE & DISPLAY
      # ---------------------------------
      - name: Prepare /mnt Storage for AVD
        run: |
          sudo mkdir -p /mnt/android-home
          sudo chown -R $USER:$USER /mnt/android-home
          df -h /mnt
          echo "✅ /mnt storage prepared."

      - name: Install VNC and Display Packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y x11vnc xvfb libpulse0
          echo "✅ VNC and required libraries installed."

      # ---------------------------------
      # STEP 4: INSTALL ANDROID COMPONENTS
      # ---------------------------------
      - name: Install Emulator and System Image
        run: |
          sdkmanager "emulator" "platform-tools" "${{ env.SYSTEM_IMAGE }}"
          echo "✅ Emulator and system image installed."

      # ---------------------------------
      # STEP 5: CREATE AND CONFIGURE AVD
      # ---------------------------------
      - name: Create and Configure AVD on /mnt
        run: |
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          
          echo "Creating AVD: ${{ env.AVD_NAME }}"
          echo "no" | avdmanager create avd --force --name "${{ env.AVD_NAME }}" --package "${{ env.SYSTEM_IMAGE }}" --device "${{ env.DEVICE_PROFILE }}"
          
          AVD_DIR="$ANDROID_AVD_HOME/${{ env.AVD_NAME }}.avd"
          CONFIG_FILE="$AVD_DIR/config.ini"

          # --- Wait for config.ini to prevent race condition ---
          echo "Waiting for AVD creation to finalize..."
          for i in {1..30}; do
            if [ -f "$CONFIG_FILE" ]; then
              echo "✅ config.ini found. AVD is ready."
              break
            fi
            sleep 1
          done
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "❌ Error: AVD config.ini not found after 30 seconds. Aborting."
            exit 1
          fi

          # --- Apply custom hardware settings ---
          echo "Applying custom hardware configuration..."
          {
            echo "hw.ramSize=12288"
            echo "disk.dataPartition.size=40960m"
            echo "hw.gpu.mode=auto"
            echo "hw.gpu.enabled=yes"
            echo "PlayStore.enabled=yes"
          } >> "$CONFIG_FILE"
          
          echo "✅ AVD configured successfully."

      # ---------------------------------
      # STEP 6: SETUP FRP TUNNEL
      # ---------------------------------
      - name: Download and Configure FRP
        run: |
          mkdir -p /tmp/frp
          wget -qO- "https://github.com/fatedier/frp/releases/download/v${{ env.FRP_VERSION }}/frp_${{ env.FRP_VERSION }}_linux_amd64.tar.gz" | tar -xz -C /tmp/frp
          mv /tmp/frp/frp_${{ env.FRP_VERSION }}_linux_amd64 /tmp/frp/bin
          
          cat > /tmp/frp/frpc.toml << EOF
          serverAddr = "${{ env.VPS_IP }}"
          serverPort = ${{ env.FRP_SERVER_PORT }}
          
          [[proxies]]
          name = "vnc-${{ github.run_id }}"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = ${{ env.VNC_PORT }}
          remotePort = ${{ env.VNC_PORT }}
          EOF
          
          echo "✅ FRP configured."

      # ---------------------------------
      # STEP 7: START VIRTUAL DISPLAY & SERVICES
      # ---------------------------------
      - name: Start Virtual Display, VNC, and Emulator
        run: |
          # --- Set environment variables for this step ---
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          export DISPLAY=${{ env.DISPLAY_PORT }}
          
          # --- Start Xvfb (Virtual Framebuffer) ---
          Xvfb $DISPLAY -screen 0 1920x1080x24 &
          sleep 5
          
          # --- Start VNC Server ---
          x11vnc -display $DISPLAY -forever -nopw -rfbport ${{ env.VNC_PORT }} -bg
          sleep 3

          # --- Start the Android Emulator ---
          emulator -avd "${{ env.AVD_NAME }}" -no-snapshot -no-audio -no-boot-anim -gpu auto &
          
          # --- Wait for Emulator to Boot ---
          echo "Waiting for emulator to boot completely..."
          timeout 300 adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done; input keyevent 82'
          
          if adb get-state | grep -q "device"; then
            echo "✅ Emulator booted and is online."
          else
            echo "❌ Emulator failed to come online after 5 minutes."
            exit 1
          fi

      # ---------------------------------
      # STEP 8: START FRP TUNNEL
      # ---------------------------------
      - name: Start FRP Tunnel to Expose VNC
        run: |
          /tmp/frp/bin/frpc -c /tmp/frp/frpc.toml &
          sleep 5
          if ! pgrep frpc > /dev/null; then
            echo "❌ FRP tunnel failed to start. Check server details and firewall."
            exit 1
          fi
          echo "✅ FRP tunnel is active. VNC is accessible at ${{ env.VPS_IP }}:${{ env.VNC_PORT }}"

      # ---------------------------------
      # STEP 9: KEEP SESSION ALIVE
      # ---------------------------------
      - name: Keep Workflow Alive via tmate
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
          timeout-minutes: ${{ env.RUNTIME_MINUTES }}
