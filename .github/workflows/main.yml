name: Android Emulator with FRP

on:
  push:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'How long to keep emulator running (minutes)'
        required: false
        default: '360'

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_11
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '360' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Display Runtime Configuration
        run: |
          echo "========================================="
          echo "Runtime: ${{ env.RUNTIME_MINUTES }} minutes"
          HOURS=$(((${{ env.RUNTIME_MINUTES }}) / 60))
          MINS=$(((${{ env.RUNTIME_MINUTES }}) % 60))
          echo "Equivalent: $HOURS h $MINS m"
          echo "========================================="

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true

      - name: Verify KVM
        run: |
          ls -la /dev/kvm 2>/dev/null || echo "KVM not available"
          nproc
          free -h

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install x86_64 System Image
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          echo "Installing x86_64 system image..."
          sdkmanager "system-images;android-30;google_apis;x86_64"

      - name: Create AVD and Find Location
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          AVD_NAME=${{ env.AVD_NAME }}
          
          echo "Creating x86_64 AVD: $AVD_NAME"
          echo no | avdmanager create avd --force \
            --name "$AVD_NAME" \
            --package "system-images;android-30;google_apis;x86_64" \
            --device "pixel"
          
          sleep 5
          
          # Find the actual AVD location
          echo "Finding AVD location..."
          AVD_LOCATION=$(avdmanager list avd | grep -A 2 "Name: $AVD_NAME" | grep "Path:" | awk '{print $NF}')
          
          if [ -z "$AVD_LOCATION" ]; then
            echo "‚ùå Could not find AVD location"
            avdmanager list avd
            exit 1
          fi
          
          echo "‚úÖ Found AVD at: $AVD_LOCATION"
          
          # Modify the config.ini at the actual location
          echo "Modifying config at: $AVD_LOCATION/config.ini"
          
          cat >> "$AVD_LOCATION/config.ini" << 'CONFEND'
          hw.ramSize=12288
          hw.arch=x86_64
          hw.cpu.model=qemu64
          disk.dataPartition.size=65536m
          hw.gpu.mode=auto
          hw.gpu.enabled=yes
          hw.accelerometer=yes
          hw.gps=yes
          hw.battery=yes
          hw.audioInput=yes
          hw.audioOutput=yes
          hw.keyboard=yes
          hw.mainKeys=no
          hw.lcd.density=440
          CONFEND
          
          echo "=== Config Contents ==="
          cat "$AVD_LOCATION/config.ini"

      - name: Start Emulator x86_64
        run: |
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          AVD_NAME=${{ env.AVD_NAME }}
          
          echo "Starting x86_64 emulator..."
          nohup emulator -avd "$AVD_NAME" \
            -no-window \
            -no-audio \
            -no-snapshot \
            -partition-size 65536 \
            -accel on \
            > emulator.log 2>&1 &
          
          PID=$!
          echo "Emulator PID: $PID"
          sleep 20
          
          echo "Restarting ADB..."
          adb kill-server 2>/dev/null || true
          sleep 2
          adb start-server
          sleep 5
          
          echo "Waiting for boot..."
          for i in {1..180}; do
            if adb devices | grep -q "device$"; then
              echo "‚úÖ Booted in $i seconds"
              adb devices
              exit 0
            fi
            
            if ! kill -0 $PID 2>/dev/null; then
              echo "‚ùå Emulator crashed"
              cat emulator.log
              exit 1
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              echo "Waiting: $i/180"
              tail -5 emulator.log
            fi
            sleep 1
          done
          
          echo "‚ùå Boot timeout"
          cat emulator.log
          exit 1

      - name: Enable ADB TCP
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          adb devices
          adb tcpip 5555
          sleep 3
          adb devices

      - name: Setup frpc
        run: |
          cat > frpc.ini << 'FRPEND'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000
          connect_timeout = 10
          dial_timeout = 10

          [adb]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5555
          remote_port = 5555
          FRPEND

      - name: Start frpc
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          nohup ./frp_0.58.1_linux_amd64/frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 10
          cat frpc.log

      - name: Verify Setup
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          echo "=== ADB Devices ==="
          adb devices
          echo ""
          echo "=== Ports ==="
          netstat -tuln | grep -E '5555|7000' || echo "Checking..."
          echo ""
          echo "=== Emulator Log ==="
          tail -15 emulator.log
          echo ""
          echo "=== frpc Log ==="
          cat frpc.log

      - name: Keep Running
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          RUNTIME_SECONDS=$(((${{ env.RUNTIME_MINUTES }}) * 60))
          HOURS=$(((${{ env.RUNTIME_MINUTES }}) / 60))
          MINS=$(((${{ env.RUNTIME_MINUTES }}) % 60))
          
          echo "========================================="
          echo "‚úÖ Android 11 x86_64 Ready"
          echo "========================================="
          echo "üìä Config:"
          echo "  ‚Ä¢ Architecture: x86_64"
          echo "  ‚Ä¢ RAM: 12 GB"
          echo "  ‚Ä¢ Storage: 65 GB"
          echo ""
          echo "üì± Connect: adb connect 159.195.6.61:5555"
          echo "‚è±Ô∏è  Runtime: $HOURS h $MINS m"
          echo "========================================="
          sleep $RUNTIME_SECONDS
