name: Android Emulator with FRP

on:
  push:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'How long to keep emulator running (minutes)'
        required: false
        default: '360'

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_11
      AVD_API_LEVEL: 30
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '360' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Display Runtime Configuration
        run: |
          echo "========================================="
          echo "Runtime configured: ${{ env.RUNTIME_MINUTES }} minutes"
          echo "Equivalent to: $(( ${{ env.RUNTIME_MINUTES }} / 60 )) hours and $(( ${{ env.RUNTIME_MINUTES }} % 60 )) minutes"
          echo "========================================="

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true

      - name: Verify KVM
        run: |
          kvm-ok || echo "KVM check completed"
          ls -la /dev/kvm 2>/dev/null || echo "KVM device not found"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 30
          ndk-version: r21e
          components: emulator,platform-tools

      - name: Install System Image
        run: |
          sdkmanager "system-images;android-30;google_apis;x86_64"

      - name: Create AVD
        run: |
          echo no | avdmanager create avd --force --name ${{ env.AVD_NAME }} --package "system-images;android-30;google_apis;x86_64" --device "pixel" --sdcard 8192M
          AVD_DIR="$HOME/.android/avd/${{ env.AVD_NAME }}.avd"
          mkdir -p $AVD_DIR
          echo "hw.ramSize=16384" >> $AVD_DIR/config.ini
          echo "disk.dataPartition.size=65536m" >> $AVD_DIR/config.ini
          echo "hw.gpu.mode=auto" >> $AVD_DIR/config.ini
          echo "hw.accelerometer=yes" >> $AVD_DIR/config.ini
          echo "hw.gps=yes" >> $AVD_DIR/config.ini

      - name: Start Emulator with KVM
        run: |
          nohup emulator -avd ${{ env.AVD_NAME }} \
            -no-window \
            -no-audio \
            -no-snapshot \
            -partition-size 65536 \
            -accel on \
            > emulator.log 2>&1 &
          
          echo "Waiting for emulator to boot with KVM..."
          for i in {1..120}; do
            if adb devices | grep -q "device$"; then
              echo "‚úÖ Emulator booted successfully!"
              break
            fi
            echo "Progress: $i/120 seconds..."
            sleep 2
          done

      - name: Enable ADB TCP on Port 5555
        run: |
          adb devices
          adb tcpip 5555
          sleep 5
          adb devices

      - name: Setup frpc Configuration
        run: |
          cat > frpc.ini <<'EOF'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000
          connect_timeout = 10
          dial_timeout = 10

          [adb]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5555
          remote_port = 5555
          EOF

      - name: Download and Start frpc
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          nohup ./frp_0.58.1_linux_amd64/frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 10
          
          echo "=== frpc Status ==="
          cat frpc.log || echo "frpc started"

      - name: Verify All Connections
        run: |
          echo "=== ADB Devices ==="
          adb devices
          echo ""
          echo "=== Port 5555 Status ==="
          netstat -tuln | grep 5555 || echo "Checking..."
          echo ""
          echo "=== Emulator Log (last 10 lines) ==="
          tail -10 emulator.log
          echo ""
          echo "=== frpc Log ==="
          cat frpc.log

      - name: System Resources
        run: |
          echo "=== CPU Cores ==="
          nproc
          echo ""
          echo "=== Memory ==="
          free -h
          echo ""
          echo "=== Disk Space ==="
          df -h /

      - name: Keep Job Running
        run: |
          RUNTIME_SECONDS=$(( ${{ env.RUNTIME_MINUTES }} * 60 ))
          HOURS=$(( ${{ env.RUNTIME_MINUTES }} / 60 ))
          MINUTES=$(( ${{ env.RUNTIME_MINUTES }} % 60 ))
          
          echo "========================================="
          echo "‚úÖ Android 11 Emulator Running"
          echo "‚úÖ 16 GB RAM | 65 GB Storage"
          echo "‚úÖ ADB TCP on port 5555"
          echo "‚úÖ frpc connected to 159.195.6.61:7000"
          echo "========================================="
          echo ""
          echo "üì± Connect from your phone:"
          echo "   adb connect 159.195.6.61:5555"
          echo ""
          echo "‚è±Ô∏è  Keeping job alive for $HOURS hours and $MINUTES minutes..."
          sleep $RUNTIME_SECONDS
