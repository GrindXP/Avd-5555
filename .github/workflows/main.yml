name: Android AVD + Tailscale (scrcpy)

on:
  workflow_dispatch:

jobs:
  avd:
    runs-on: ubuntu-22.04

    steps:
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup /mnt Storage
        run: |
          sudo mkdir -p /mnt/avd/.android/avd
          sudo chown -R runner:runner /mnt/avd

      - name: Install System Image
        run: |
          sdkmanager "system-images;android-30;google_apis;x86_64"

      - name: Create AVD
        run: |
          export HOME=/mnt/avd
          export ANDROID_AVD_HOME=/mnt/avd/.android/avd
          
          echo no | avdmanager create avd \
            -n android11 \
            -k "system-images;android-30;google_apis;x86_64" \
            -d "pixel_5"
          
          sleep 3
          
          cat >> "/mnt/avd/.android/avd/android11.avd/config.ini" << EOF
          hw.ramSize=8192
          disk.dataPartition.size=8192M
          hw.gpu.mode=swiftshader_indirect
          hw.gpu.enabled=yes
          EOF

      - name: Start AVD
        run: |
          export HOME=/mnt/avd
          export ANDROID_AVD_HOME=/mnt/avd/.android/avd
          
          nohup $ANDROID_HOME/emulator/emulator \
            -avd android11 \
            -no-window \
            -gpu swiftshader_indirect \
            -no-audio \
            -no-boot-anim \
            -memory 8192 \
            > /tmp/emu.log 2>&1 &
          
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          echo "âœ… AVD booted"

      - name: Enable Native Lock
        run: |
          adb shell cmd lock_settings set-pin 1234
          echo "âœ… Lock enabled"

      - name: Enable ADB TCP (with retry)
        run: |
          # Kill and restart ADB daemon
          adb kill-server
          sleep 2
          adb start-server
          sleep 3
          
          # Wait for device
          adb wait-for-device
          sleep 2
          
          # Retry loop for tcpip command
          for i in {1..5}; do
            echo "Attempt $i: Enabling TCP mode..."
            if adb tcpip 5555; then
              echo "âœ… TCP mode enabled"
              break
            else
              echo "Failed, retrying in 3s..."
              adb kill-server
              sleep 2
              adb start-server
              sleep 3
              adb wait-for-device
              sleep 2
            fi
            
            if [ $i -eq 5 ]; then
              echo "âŒ Failed after 5 attempts"
              exit 1
            fi
          done
          
          sleep 5
          adb connect 127.0.0.1:5555
          adb devices -l
          echo "âœ… ADB TCP ready"

      - name: Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
          sleep 5
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale: $TS_IP"

      - name: Setup Port Forward (socat)
        run: |
          sudo apt-get install -y socat
          
          # Forward Tailscale IP:5555 â†’ localhost:5555
          nohup socat TCP-LISTEN:5555,fork,bind=$TAILSCALE_IP TCP:127.0.0.1:5555 > /tmp/socat.log 2>&1 &
          
          sleep 3
          
          # Open firewall
          sudo ufw allow 5555/tcp
          sudo ufw --force enable
          
          echo ""
          echo "=== Port forwarding active ==="
          sudo netstat -tulpn | grep 5555
          
          echo ""
          echo "âœ… Port 5555 forwarded from $TAILSCALE_IP to localhost"

      - name: Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ“± AVD Ready (8GB RAM)        â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ðŸŒ IP: $TAILSCALE_IP:5555    â•‘"
          echo "â•‘  ðŸ’¾ RAM: 8GB                  â•‘"
          echo "â•‘  ðŸ” PIN: 1234                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ”¥ Connect from Windows:"
          echo "   adb connect $TAILSCALE_IP:5555"
          echo "   scrcpy --serial $TAILSCALE_IP:5555"

      - name: Keep Alive
        run: |
          while true; do
            # Check socat is running
            if ! pgrep -f "socat.*5555" > /dev/null; then
              echo "Restarting socat..."
              nohup socat TCP-LISTEN:5555,fork,bind=$TAILSCALE_IP TCP:127.0.0.1:5555 > /tmp/socat.log 2>&1 &
            fi
            
            # Check ADB connection
            if ! adb devices | grep -q "127.0.0.1:5555"; then
              echo "Reconnecting ADB..."
              adb connect 127.0.0.1:5555
            fi
            
            echo "[$(date '+%H:%M')] âœ… $TAILSCALE_IP:5555"
            sleep 120
          done
