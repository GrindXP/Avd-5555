name: Android mnt SSH Terminal

on:
  push:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'How long to keep emulator running (minutes)'
        required: false
        default: '360'

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_11
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '360' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true

      - name: Check /mnt Space
        run: |
          echo "=== /mnt Volume ==="
          df -h /mnt
          sudo mkdir -p /mnt/android-sdk-data
          sudo chown -R runner:runner /mnt/android-sdk-data 2>/dev/null || true

      - name: Install x86_64 System Image
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          sdkmanager "emulator" "platform-tools"
          sdkmanager "system-images;android-30;google_apis;x86_64"

      - name: Create AVD on /mnt with Full Control
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          
          # Create directories with proper ownership
          sudo mkdir -p /mnt/android-home/.android/avd
          sudo chown -R runner:runner /mnt/android-home
          
          AVD_HOME=/mnt/android-home/.android/avd
          AVD_NAME=${{ env.AVD_NAME }}
          
          echo "AVD Home: $AVD_HOME"
          ls -la /mnt/android-home/
          
          # Set HOME to /mnt/android-home so avdmanager uses it
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=$AVD_HOME
          
          echo "Creating AVD with HOME=$HOME and ANDROID_AVD_HOME=$ANDROID_AVD_HOME"
          
          # Create AVD
          echo no | avdmanager create avd \
            --force \
            --name "$AVD_NAME" \
            --package "system-images;android-30;google_apis;x86_64" \
            --device "pixel"
          
          sleep 3
          
          # Verify creation
          echo "=== Listing AVDs ==="
          avdmanager list avd
          
          AVD_DIR="$AVD_HOME/$AVD_NAME.avd"
          
          if [ ! -d "$AVD_DIR" ]; then
            echo "‚ùå AVD not created at $AVD_DIR"
            ls -la "$AVD_HOME"
            exit 1
          fi
          
          echo "‚úÖ AVD created: $AVD_DIR"
          
          # Update config for 40GB storage and 12GB RAM
          cat >> "$AVD_DIR/config.ini" << 'CONFEND'
          hw.ramSize=12288
          hw.arch=x86_64
          hw.cpu.model=qemu64
          disk.dataPartition.size=40960m
          hw.gpu.mode=auto
          hw.gpu.enabled=yes
          hw.accelerometer=yes
          hw.gps=yes
          hw.battery=yes
          hw.audioInput=yes
          hw.audioOutput=yes
          hw.keyboard=yes
          hw.mainKeys=no
          hw.lcd.density=440
          CONFEND
          
          echo "=== Config Created ==="
          cat "$AVD_DIR/config.ini"
          
          echo ""
          echo "=== /mnt Usage ==="
          df -h /mnt

      - name: Start Emulator from /mnt
        run: |
          export HOME=/mnt/android-home
          export ANDROID_AVD_HOME=/mnt/android-home/.android/avd
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          
          AVD_NAME=${{ env.AVD_NAME }}
          
          echo "Starting emulator from /mnt (12GB RAM, 40GB storage)..."
          nohup emulator -avd "$AVD_NAME" \
            -no-window \
            -no-audio \
            -no-snapshot \
            -accel on \
            -no-metrics \
            > /tmp/emulator.log 2>&1 &
          
          PID=$!
          echo "Emulator PID: $PID"
          sleep 35
          
          echo "Restarting ADB..."
          adb kill-server 2>/dev/null || true
          sleep 2
          adb start-server
          sleep 5
          
          echo "Waiting for emulator..."
          SUCCESS=0
          for i in {1..180}; do
            if adb devices | grep -q "device$"; then
              echo "‚úÖ Emulator booted! ($i sec)"
              SUCCESS=1
              break
            fi
            
            if ! kill -0 $PID 2>/dev/null; then
              echo "‚ùå Emulator died"
              cat /tmp/emulator.log
              exit 1
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              echo "Boot progress: $i/180..."
              tail -5 /tmp/emulator.log
            fi
            
            sleep 1
          done
          
          if [ $SUCCESS -eq 0 ]; then
            echo "‚ùå Boot failed"
            cat /tmp/emulator.log
            exit 1
          fi

      - name: Enable ADB TCP
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          adb devices
          adb tcpip 5555
          sleep 3
          adb devices

      - name: Verify Setup
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          echo "=== Device Info ==="
          adb devices
          echo ""
          echo "=== Memory (12GB) ==="
          adb shell "cat /proc/meminfo | grep MemTotal"
          echo ""
          echo "=== Internal Storage (40GB) ==="
          adb shell "df -h /data" 2>/dev/null || echo "Checking..."
          echo ""
          echo "=== /mnt Usage ==="
          df -h /mnt
          echo ""
          echo "=== Ports ==="
          netstat -tuln | grep 5555

      - name: Setup SSH Terminal Access via tmate
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
          timeout-minutes: 120

      - name: Keep Running
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          RUNTIME_SECONDS=$(((${{ env.RUNTIME_MINUTES }}) * 60))
          HOURS=$(((${{ env.RUNTIME_MINUTES }}) / 60))
          MINS=$(((${{ env.RUNTIME_MINUTES }}) % 60))
          
          echo "========================================="
          echo "‚úÖ Android 11 x86_64 Emulator Ready"
          echo "========================================="
          echo ""
          echo "üìä Specifications:"
          echo "  ‚Ä¢ OS: Android 11 (API 30)"
          echo "  ‚Ä¢ Architecture: x86_64"
          echo "  ‚Ä¢ RAM: 12 GB"
          echo "  ‚Ä¢ Internal Storage: 40 GB (/mnt)"
          echo "  ‚Ä¢ Location: /mnt/android-home"
          echo "  ‚Ä¢ Acceleration: KVM"
          echo ""
          echo "üñ•Ô∏è  SSH Terminal Access:"
          echo "  1. Check GitHub Actions logs for SSH command"
          echo "  2. SSH in: ssh runner@<host>"
          echo "  3. Use ADB directly: adb devices"
          echo "  4. Get shell: adb shell"
          echo "  5. View screen: scrcpy --video-codec=h264 --video-bit-rate=5M"
          echo ""
          echo "üì± Access tmate session for 120 minutes"
          echo ""
          echo "‚è±Ô∏è  Emulator Runtime: $HOURS h $MINS m"
          echo "========================================="
          sleep $RUNTIME_SECONDS
