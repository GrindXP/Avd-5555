name: Android Emulator with FRP

on:
  push:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'How long to keep emulator running (minutes)'
        required: false
        default: '360'

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    env:
      AVD_NAME: android_11
      AVD_API_LEVEL: 30
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '360' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Display Runtime Configuration
        run: |
          echo "========================================="
          echo "Runtime configured: ${{ env.RUNTIME_MINUTES }} minutes"
          echo "Equivalent to: $(( ${{ env.RUNTIME_MINUTES }} / 60 )) hours and $(( ${{ env.RUNTIME_MINUTES }} % 60 )) minutes"
          echo "========================================="

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true

      - name: Verify KVM
        run: |
          echo "=== Checking KVM Setup ==="
          ls -la /dev/kvm 2>/dev/null || echo "‚ö†Ô∏è  KVM device not found"
          kvm-ok 2>/dev/null || echo "KVM check not available (but /dev/kvm exists)"
          echo ""
          echo "=== System Info ==="
          nproc
          free -h
          df -h /

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install System Image and Tools
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          sdkmanager "emulator" "platform-tools"
          sdkmanager "system-images;android-30;google_apis;x86_64"

      - name: Create AVD Properly
        run: |
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
          
          echo "Creating base AVD..."
          # Accept all prompts for SD card, etc.
          echo y | echo no | avdmanager create avd --force \
            --name "${{ env.AVD_NAME }}" \
            --package "system-images;android-30;google_apis;x86_64" \
            --device "pixel"
          
          # Wait for files to generate
          sleep 5
          
          AVD_DIR="$HOME/.android/avd/${{ env.AVD_NAME }}.avd"
          AVD_INI_DIR="$HOME/.android/avd"
          
          # Create the AVD ini file if missing
          if [ ! -f "$AVD_INI_DIR/${{ env.AVD_NAME }}.ini" ]; then
            cat > "$AVD_INI_DIR/${{ env.AVD_NAME }}.ini" << EOF
avd.ini.path=$AVD_DIR
avd.ini.displayname=${{ env.AVD_NAME }}
EOF
          fi
          
          # Ensure base config.ini exists and append/modify settings
          if [ ! -f "$AVD_DIR/config.ini" ]; then
            touch "$AVD_DIR/config.ini"
          fi
          
          # Set high RAM (16GB = 16384MB)
          echo "hw.ramSize=16384" >> "$AVD_DIR/config.ini"
          
          # Set large internal storage (65GB)
          echo "disk.dataPartition.size=65536m" >> "$AVD_DIR/config.ini"
          
          # Enable GPU acceleration
          echo "hw.gpu.mode=auto" >> "$AVD_DIR/config.ini"
          echo "hw.gpu.enabled=yes" >> "$AVD_DIR/config.ini"
          
          # Enable features
          echo "hw.accelerometer=yes" >> "$AVD_DIR/config.ini"
          echo "hw.gps=yes" >> "$AVD_DIR/config.ini"
          echo "hw.battery=yes" >> "$AVD_DIR/config.ini"
          echo "hw.audioInput=yes" >> "$AVD_DIR/config.ini"
          echo "hw.audioOutput=yes" >> "$AVD_DIR/config.ini"
          
          # Set SD card size if needed
          echo "hw.sdCard=yes" >> "$AVD_DIR/config.ini"
          echo "hw.sdCard.size=8192M" >> "$AVD_DIR/config.ini"
          
          # Optimize for CI
          echo "hw.keyboard=yes" >> "$AVD_DIR/config.ini"
          echo "hw.mainKeys=no" >> "$AVD_DIR/config.ini"
          echo "hw.trackBall=no" >> "$AVD_DIR/config.ini"
          echo "hw.dPad=no" >> "$AVD_DIR/config.ini"
          echo "hw.lcd.density=440" >> "$AVD_DIR/config.ini"
          echo "hw.logcatBufferSize=16384" >> "$AVD_DIR/config.ini"
          
          echo "=== Available AVDs ==="
          avdmanager list avd
          echo ""
          echo "=== AVD Directory Contents ==="
          ls -la "$AVD_DIR"
          echo ""
          echo "=== Complete AVD Config ==="
          cat "$AVD_DIR/config.ini"
          echo ""
          echo "=== AVD Ini File ==="
          cat "$AVD_INI_DIR/${{ env.AVD_NAME }}.ini"

      - name: Start Emulator with KVM
        run: |
          export PATH=$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$PATH
          
          echo "=== Pre-Start Check ==="
          emulator -list-avds
          
          echo "Starting Android 11 emulator with KVM acceleration..."
          nohup emulator -avd ${{ env.AVD_NAME }} \
            -no-window \
            -no-audio \
            -no-snapshot \
            -partition-size 65536 \
            -accel on \
            -verbose \
            > emulator.log 2>&1 &
          
          EMULATOR_PID=$!
          echo "Emulator PID: $EMULATOR_PID"
          sleep 15
          
          # Restart ADB daemon
          echo "Restarting ADB daemon..."
          adb kill-server 2>/dev/null || true
          sleep 2
          adb start-server
          sleep 5
          
          # Wait for emulator detection
          echo "Waiting for emulator to be detected by ADB..."
          BOOT_TIMEOUT=180
          DETECTED=0
          
          for i in $(seq 1 $BOOT_TIMEOUT); do
            DEVICES=$(adb devices 2>&1)
            
            if echo "$DEVICES" | grep -q "${{ env.AVD_NAME }}.*device$"; then
              echo "‚úÖ Emulator detected after $i seconds!"
              DETECTED=1
              break
            fi
            
            if ! kill -0 $EMULATOR_PID 2>/dev/null; then
              echo "‚ùå Emulator process crashed at attempt $i"
              echo "=== Last 30 lines of emulator log ==="
              tail -30 emulator.log
              exit 1
            fi
            
            if [ $((i % 30)) -eq 0 ]; then
              echo "Still waiting... ($i/$BOOT_TIMEOUT seconds)"
              echo "ADB: $DEVICES"
              tail -5 emulator.log
            fi
            
            sleep 1
          done
          
          if [ $DETECTED -eq 0 ]; then
            echo "‚ùå Boot timeout"
            ps aux | grep emulator
            adb devices -l
            tail -50 emulator.log
            exit 1
          fi

      - name: Enable ADB TCP on Port 5555
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          echo "=== ADB Devices Before TCP ==="
          adb devices
          adb tcpip 5555
          sleep 5
          echo "=== ADB Devices After TCP ==="
          adb devices

      - name: Setup frpc Configuration
        run: |
          cat > frpc.ini <<'EOF'
          [common]
          server_addr = 159.195.6.61
          server_port = 7000
          connect_timeout = 10
          dial_timeout = 10

          [adb]
          type = tcp
          local_ip = 127.0.0.1
          local_port = 5555
          remote_port = 5555
          EOF
          cat frpc.ini

      - name: Download and Start frpc
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          nohup ./frp_0.58.1_linux_amd64/frpc -c frpc.ini > frpc.log 2>&1 &
          sleep 10
          cat frpc.log

      - name: Verify All Connections
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          echo "üì± ADB Devices: $(adb devices)"
          echo "üîå Ports: $(netstat -tuln | grep -E '5555|7000' || echo 'Not ready')"
          echo "üñ•Ô∏è  Emulator: $(ps aux | grep emulator | grep -v grep)"
          echo "üìù Emulator Log: $(tail -15 emulator.log)"
          echo "üåê frpc Log: $(cat frpc.log)"

      - name: System Resources
        run: |
          echo "CPU: $(nproc)"
          free -h
          df -h /

      - name: Keep Job Running
        run: |
          export PATH=$ANDROID_HOME/platform-tools:$PATH
          RUNTIME_SECONDS=$(( ${{ env.RUNTIME_MINUTES }} * 60 ))
          HOURS=$(( ${{ env.RUNTIME_MINUTES }} / 60 ))
          MINUTES=$(( ${{ env.RUNTIME_MINUTES }} % 60 ))
          echo "‚úÖ Ready! Connect: adb connect 159.195.6.61:5555"
          echo "‚è±Ô∏è  Running for $HOURS h $MINUTES m"
          sleep $RUNTIME_SECONDS
